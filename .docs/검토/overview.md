# 배터리 화재 감지 IR 카메라 시스템 검토

## 1. 개요

### 1.1 목적
- 자동차 배터리 화재 감지
- 열폭주 조기 감지 및 알람

### 1.2 대상 환경
| 항목 | 사양 |
|------|------|
| 배터리 크기 | 1700 × 2800mm |
| 설치 구조 | 랙(선반) 층층이 배치 |
| Working Distance | 250mm (카메라 ~ 배터리 상단) |
| 유효 셀 영역 | 외곽 15% 제외 → 1190 × 1960mm |

---

## 2. IR 카메라 선정

### 2.1 MLX90640 광각 사양
| 항목 | 값 |
|------|-----|
| 해상도 | 32 × 24 픽셀 |
| FOV (광각) | 110° × 75° |
| 온도 범위 | -40°C ~ 300°C |
| 정확도 | ±1°C |
| 인터페이스 | I2C |
| 프레임 레이트 | 4Hz (최대 64Hz) |

### 2.2 WD 250mm 기준 커버 영역
| 항목 | 값 |
|------|-----|
| 수평 커버 | 714mm |
| 수직 커버 | 384mm |
| 수평 픽셀 해상도 | 22.3mm/pixel |
| 수직 픽셀 해상도 | 16.0mm/pixel |

---

## 3. 배치 검토

### 3.1 배치 옵션 비교

| 배치 방식 | 카메라 수 | 해상도 | 복잡도 |
|-----------|----------|--------|--------|
| 수직 그리드 | 24개 | 균일 22mm | 낮음 |
| 90° 회전 | 20개 | 균일 22mm | 낮음 |
| 45° 틸트 그리드 | 8개 | 30-40mm | 보통 |
| **4개 모서리 틸트** | **4개** | 20-40mm | 높음 |

### 3.2 최종 선정: 4개 모서리 배치

```
┌─────────────────────────────────────────────────┐
│ ◢                                           ◣   │
│   ╲                                       ╱     │
│     ╲         유효 셀 영역            ╱         │
│       ╲       1190 × 1960mm         ╱           │
│         ╲                         ╱             │
│           ╲                     ╱               │
│             ╲                 ╱                 │
│               ╲             ╱                   │
│                 ╲         ╱                     │
│ ◥                                           ◤   │
└─────────────────────────────────────────────────┘

◢◣◤◥ = MLX90640 카메라 (45° 틸트, 중앙 방향)
```

### 3.3 배치 상세
| 항목 | 값 |
|------|-----|
| 카메라 위치 | 4개 모서리 |
| 틸트 각도 | 45° (중앙 방향) |
| 층당 카메라 수 | 4개 |
| 오버랩 영역 | 중앙부 4개 카메라 중첩 |

---

## 4. 데이터 융합 알고리즘

### 4.1 필요성
- 단일 카메라 중앙부 해상도: 78mm/pixel (불충분)
- 4개 카메라 융합 시: 30-40mm/pixel (충분)

### 4.2 알고리즘 구조

```
┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│   CAM 1     │   │   CAM 2     │   │   CAM 3     │   │   CAM 4     │
│  32×24 px   │   │  32×24 px   │   │  32×24 px   │   │  32×24 px   │
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │                 │
       ▼                 ▼                 ▼                 ▼
┌──────────────────────────────────────────────────────────────────┐
│                    1. 좌표 변환 (Pixel → World)                   │
└──────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────┐
│                    2. 가상 그리드 매핑 (20mm 해상도)              │
└──────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────┐
│                    3. 가중 융합 + 칼만 필터                       │
└──────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────┐
│                    4. 고해상도 온도 맵 (60 × 98)                  │
└──────────────────────────────────────────────────────────────────┘
```

### 4.3 가중 융합 원리

```
각 그리드 셀에 대해:

1. 해당 위치를 보는 카메라들 확인 (1~4개)

2. 각 카메라별 가중치 계산
   - 거리 가중치: 가까울수록 높음
   - 각도 가중치: 정면일수록 높음

3. 가중 평균으로 최종 온도 계산
   T = (T1×W1 + T2×W2 + T3×W3 + T4×W4) / (W1+W2+W3+W4)
```

### 4.4 칼만 필터 적용
- 목적: 노이즈 제거, 시계열 추적
- 원리: 예측값 + 측정값 → 최적 추정
- 효과: 온도 정확도 향상, 변화율 계산 가능

### 4.5 융합 후 성능

| 영역 | 오버랩 수 | 해상도 | 100mm 셀 감지 |
|------|----------|--------|--------------|
| 가장자리 | 2개 | 20-25mm | 4-5 픽셀 |
| 중앙 | 4개 | 30-40mm | 2.5-3 픽셀 |

---

## 5. 글로벌 좌표 변환

### 5.1 변환 과정

```
Step 1: 픽셀 → 각도
        픽셀 위치에 따라 FOV 내 각도 계산

Step 2: 카메라 틸트 적용
        픽셀 각도 + 카메라 설치 각도

Step 3: 광선-평면 교차점 계산
        광선이 배터리 표면(z=0)과 만나는 점
```

### 5.2 룩업 테이블
- 설치 시 1회 계산하여 저장
- 실시간 처리 시 테이블 조회만 → 빠른 처리

---

## 6. 캘리브레이션

### 6.1 권장 방식: 정밀 브라켓

```
캘리브레이션 최소화 → 기계적 정밀도로 해결

┌──────────────────────────────────────┐
│  ┌──◢                       ◣──┐   │
│  │  │    정밀 제작된        │  │   │
│  │  │    고정 브라켓        │  │   │
│  │  │    (45° 각도 고정)    │  │   │
│  └──◥                       ◤──┘   │
└──────────────────────────────────────┘

- CNC 가공 또는 3D 프린팅
- 정밀도: ±0.5° 이내
```

### 6.2 설치 후 확인

```
중앙에 열점 1개 배치 → 4개 카메라 좌표 확인

오차 10mm 이내 → OK
오차 10mm 초과 → 브라켓 재조정
```

---

## 7. 하드웨어 설계

### 7.1 시스템 구성

```
┌─────────────────────────────────────────────────────────────┐
│                    통합 제어 보드                            │
│                                                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │MLX90640 │ │MLX90640 │ │MLX90640 │ │MLX90640 │           │
│  │  CAM1   │ │  CAM2   │ │  CAM3   │ │  CAM4   │           │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘           │
│       └─────┬─────┴─────┬─────┴─────┬─────┘                │
│             │      I2C  │           │                       │
│       ┌─────┴───────────┴───────────┴─────┐                │
│       │         I2C 멀티플렉서            │                │
│       │           TCA9548A                │                │
│       └─────────────────┬─────────────────┘                │
│                         │                                   │
│                   ┌─────┴─────┐                            │
│                   │  ESP32-S3 │                            │
│                   └─────┬─────┘                            │
│                         │                                   │
│                   ┌─────┴─────┐                            │
│                   │   W5500   │                            │
│                   └─────┬─────┘                            │
│                         │                                   │
│              ┌──────────┴──────────┐                       │
│              │      PoE 모듈       │                       │
│              └──────────┬──────────┘                       │
└─────────────────────────┼───────────────────────────────────┘
                          │
                     PoE 케이블
                          │
                    ┌───────────┐
                    │ PoE 스위치 │
                    └───────────┘
```

### 7.2 부품 목록

| 부품 | 모델 | 수량 | 역할 |
|------|------|------|------|
| IR 카메라 | MLX90640 광각 | 4 | 온도 측정 |
| I2C 멀티플렉서 | TCA9548A | 1 | 주소 충돌 해결 |
| MCU | ESP32-S3 | 1 | 데이터 처리 |
| Ethernet | W5500 | 1 | 네트워크 통신 |
| PoE 모듈 | AG9905M | 1 | 전원 수전 |

### 7.3 전원 설계

```
PoE 입력: 48V DC (IEEE 802.3af)
         │
         ▼
    ┌─────────────┐
    │  PoE 모듈   │  → 5V / 2A 출력
    └──────┬──────┘
           │
     ┌─────┴─────┐
     ▼           ▼
   3.3V         5V
  (ESP32)    (MLX90640)

총 소비전력: ~3.5W (PoE 802.3af 12.95W 이내)
```

### 7.4 데이터 패킷 구조

```
┌──────────────────────────────────────────────────┐
│  Header (16 bytes)                               │
│  - Sync, Module ID, Timestamp, Status            │
├──────────────────────────────────────────────────┤
│  Payload (6,144 bytes)                           │
│  - CAM1~4 각 1,536 bytes (768 × 2)              │
├──────────────────────────────────────────────────┤
│  Footer (4 bytes)                                │
│  - CRC32                                         │
└──────────────────────────────────────────────────┘
                    총 6,164 bytes/프레임
                    전송률: ~24KB/s @ 4Hz
```

### 7.5 예상 비용

| 부품 | 단가 | 수량 | 금액 |
|------|------|------|------|
| MLX90640 광각 | $40 | 4 | $160 |
| ESP32-S3 | $8 | 1 | $8 |
| W5500 모듈 | $5 | 1 | $5 |
| TCA9548A | $3 | 1 | $3 |
| PoE 모듈 | $10 | 1 | $10 |
| PCB + 부품 | $20 | 1 | $20 |
| **합계** | | | **~$206/모듈** |

---

## 8. 화재 감지 알고리즘

### 8.1 감지 기준

| 감지 유형 | 조건 | 알람 레벨 |
|-----------|------|----------|
| 절대 온도 | > 60°C | WARNING |
| 절대 온도 | > 80°C | CRITICAL |
| 온도 상승률 | > 10°C/min | CRITICAL |
| 핫스팟 | 주변 대비 > 15°C | WARNING |

### 8.2 감지 전략

```
1차: 급격한 온도 상승 감지 (전체 영역)
     → ΔT > 10°C/min 알람

2차: 절대 온도 임계값 (전체 영역)
     → T > 60°C 경고, T > 80°C 알람

3차: 인접 픽셀 온도차 분석 (핫스팟)
     → 주변 대비 ΔT > 15°C 알람
```

---

## 9. 결론

### 9.1 최종 사양 요약

| 항목 | 값 |
|------|-----|
| 카메라 | MLX90640 광각 × 4 |
| 배치 | 모서리 45° 틸트 |
| 층당 카메라 수 | 4개 |
| 유효 해상도 | 20-40mm/pixel |
| 통신 | PoE (전원 + 데이터) |
| 모듈 비용 | ~$206 |

### 9.2 화재 감지 성능

| 항목 | 판정 |
|------|------|
| 열폭주 감지 | ✅ 가능 |
| 셀 단위 감지 | ✅ 가능 (2.5-5 픽셀/셀) |
| 핫스팟 위치 파악 | ✅ 가능 |
| 온도 정확도 | ✅ ±0.5°C (융합 후) |

---

## 10. 다음 단계

1. 회로도 상세 설계
2. PCB 레이아웃
3. 정밀 브라켓 3D 설계
4. 펌웨어 개발
5. 데이터 융합 알고리즘 구현
6. 프로토타입 제작 및 테스트
