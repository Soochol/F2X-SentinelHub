# 배터리 화재 감지 IR 카메라 시스템 검토

## 1. 개요

### 1.1 목적
- 자동차 배터리 화재 감지
- 열폭주 조기 감지 및 알람

### 1.2 대상 환경
| 항목 | 사양 |
|------|------|
| 배터리 크기 | 1700 × 2800mm |
| 설치 구조 | 랙(선반) 층층이 배치 |
| Working Distance | 250mm (카메라 ~ 배터리 상단) |
| 유효 셀 영역 | 외곽 15% 제외 → 1190 × 1960mm |

---

## 2. IR 카메라 선정

### 2.1 MLX90640 광각 사양
| 항목 | 값 |
|------|-----|
| 해상도 | 32 × 24 픽셀 |
| FOV (광각) | 110° × 75° |
| 온도 범위 | -40°C ~ 300°C |
| 정확도 | ±1°C |
| 인터페이스 | I2C |
| 프레임 레이트 | 4Hz (최대 64Hz) |

### 2.2 WD 250mm 기준 커버 영역
| 항목 | 값 |
|------|-----|
| 수평 커버 | 714mm |
| 수직 커버 | 384mm |
| 수평 픽셀 해상도 | 22.3mm/pixel |
| 수직 픽셀 해상도 | 16.0mm/pixel |

---

## 3. 배치 검토

### 3.1 배치 옵션 비교

| 배치 방식 | 카메라 수 | 해상도 | 복잡도 |
|-----------|----------|--------|--------|
| 수직 그리드 | 24개 | 균일 22mm | 낮음 |
| 90° 회전 | 20개 | 균일 22mm | 낮음 |
| 45° 틸트 그리드 | 8개 | 30-40mm | 보통 |
| **4개 모서리 틸트** | **4개** | 20-40mm | 높음 |

### 3.2 최종 선정: 4개 모서리 배치

```
┌─────────────────────────────────────────────────┐
│ ◢                                           ◣   │
│   ╲                                       ╱     │
│     ╲         유효 셀 영역            ╱         │
│       ╲       1190 × 1960mm         ╱           │
│         ╲                         ╱             │
│           ╲                     ╱               │
│             ╲                 ╱                 │
│               ╲             ╱                   │
│                 ╲         ╱                     │
│ ◥                                           ◤   │
└─────────────────────────────────────────────────┘

◢◣◤◥ = MLX90640 카메라 (45° 틸트, 중앙 방향)
```

### 3.3 배치 상세
| 항목 | 값 |
|------|-----|
| 카메라 위치 | 4개 모서리 |
| 틸트 각도 | 45° (중앙 방향) |
| 층당 카메라 수 | 4개 |
| 오버랩 영역 | 중앙부 4개 카메라 중첩 |

---

## 4. 데이터 융합 알고리즘

### 4.1 필요성
- 단일 카메라 중앙부 해상도: 78mm/pixel (불충분)
- 4개 카메라 융합 시: 30-40mm/pixel (충분)

### 4.2 4개 카메라 융합의 핵심 이점

```
단순히 해상도만 좋아지는 것이 아님!
```

| 이점 | 설명 | 효과 |
|------|------|------|
| 온도 정확도 향상 | 다중 측정 → 노이즈 평균화 | ±1°C → ±0.5°C |
| 반사 영향 최소화 | 여러 각도에서 측정 | 반사광 필터링 |
| 신뢰성 (Redundancy) | 1개 고장 시 나머지 보완 | 시스템 안정성 |
| 사각지대 제거 | 요철/장애물 회피 | 전체 커버리지 |

```
IR 카메라의 고질적 문제: 표면 반사

         반사광
            ↗
    CAM1 ←─── 배터리 셀 ───→ CAM2는 정확한 값 측정
            ↘

→ 여러 각도에서 보면 반사 영향을 최소화할 수 있음
```

### 4.3 알고리즘 구조

```
┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│   CAM 1     │   │   CAM 2     │   │   CAM 3     │   │   CAM 4     │
│  32×24 px   │   │  32×24 px   │   │  32×24 px   │   │  32×24 px   │
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │                 │
       ▼                 ▼                 ▼                 ▼
┌──────────────────────────────────────────────────────────────────┐
│                    1. 좌표 변환 (Pixel → World)                   │
└──────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────┐
│                    2. 가상 그리드 매핑 (20mm 해상도)              │
└──────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────┐
│                    3. 가중 융합 + 칼만 필터                       │
└──────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────┐
│                    4. 고해상도 온도 맵 (60 × 98)                  │
└──────────────────────────────────────────────────────────────────┘
```

### 4.4 가중 융합 원리

```
각 그리드 셀에 대해:

1. 해당 위치를 보는 카메라들 확인 (1~4개)

2. 각 카메라별 가중치 계산
   - 거리 가중치: 가까울수록 높음
   - 각도 가중치: 정면일수록 높음

3. 가중 평균으로 최종 온도 계산
   T = (T1×W1 + T2×W2 + T3×W3 + T4×W4) / (W1+W2+W3+W4)
```

### 4.5 칼만 필터 적용
- 목적: 노이즈 제거, 시계열 추적
- 원리: 예측값 + 측정값 → 최적 추정
- 효과: 온도 정확도 향상, 변화율 계산 가능

### 4.6 융합 후 성능

| 영역 | 오버랩 수 | 해상도 | 100mm 셀 감지 |
|------|----------|--------|--------------|
| 가장자리 | 2개 | 20-25mm | 4-5 픽셀 |
| 중앙 | 4개 | 30-40mm | 2.5-3 픽셀 |

---

## 5. 글로벌 좌표 변환

### 5.1 왜 좌표 변환이 필요한가?

```
문제: 4개 카메라 데이터를 어떻게 합치나?

CAM1의 (15, 12) 픽셀 = 45°C  ─┐
CAM3의 (20, 8) 픽셀 = 47°C   ─┴─→ 같은 곳? 다른 곳?

월드 좌표 없이는 알 수 없음!
```

```
월드 좌표 변환 후:

CAM1의 (15, 12) → 배터리 (600mm, 900mm) → 45°C ─┐
CAM3의 (20, 8)  → 배터리 (600mm, 900mm) → 47°C ─┴─→ 같은 위치! 융합 가능
```

### 5.2 변환 과정

```
Step 1: 픽셀 → 각도
        ┌─────────────────────────────────┐
        │  FOV: 110° × 75°                │
        │  중심 픽셀: (16, 12)             │
        │                                  │
        │  픽셀 (px, py)의 각도:           │
        │  θ_h = (px - 15.5) / 31 × 110°  │
        │  θ_v = (py - 11.5) / 23 × 75°   │
        └─────────────────────────────────┘

Step 2: 카메라 틸트 적용
        ┌─────────────────────────────────┐
        │       │ 수직                     │
        │       │╲ 45°                    │
        │       │ ╲                       │
        │       │  ╲ 실제 광선 방향        │
        │       │   ╲                     │
        │       └────────                 │
        │                                  │
        │  광선 방향 = 픽셀 각도 + 틸트 각도 │
        └─────────────────────────────────┘

Step 3: 광선-평면 교차점 계산
        ┌─────────────────────────────────┐
        │  카메라 ●                        │
        │          ╲                      │
        │           ╲ 광선                 │
        │            ╲                    │
        │  ───────────●─────── Z=0        │
        │             ↑                   │
        │         교차점 (world_x, world_y)│
        └─────────────────────────────────┘
```

### 5.3 룩업 테이블 (Lookup Table)

#### 5.3.1 개념

```
룩업 테이블 = 미리 계산해둔 "정답표"

┌─────────────────────────────────────────────────┐
│  실시간 계산 방식 (느림)                          │
│                                                  │
│  매 프레임마다:                                   │
│  픽셀(15,12) → 삼각함수 → 틸트 보정 → 광선 추적   │
│              → 복잡한 수식 계산...                │
│              → 배터리 좌표 (600, 900)mm          │
│                                                  │
│  32×24×4 = 3,072번 계산 × 4Hz = 초당 12,288번    │
└─────────────────────────────────────────────────┘

                    vs

┌─────────────────────────────────────────────────┐
│  룩업 테이블 방식 (빠름)                          │
│                                                  │
│  설치 시 1회: 모든 픽셀 미리 계산 → 테이블 저장    │
│  실시간: 테이블[15][12] 조회 → 즉시 (600, 900)   │
│                                                  │
│  계산 없이 조회만 → 빠른 처리                     │
└─────────────────────────────────────────────────┘
```

#### 5.3.2 테이블 구조

```
┌──────────────────────────────────────────────────┐
│  CAM1 룩업 테이블                                 │
├──────────┬───────────────────────────────────────┤
│ 픽셀     │ 배터리 좌표 (mm)                       │
├──────────┼───────────────────────────────────────┤
│ (0, 0)   │ (-150.2, -98.5)  ← 유효 영역 밖       │
│ (0, 1)   │ (-150.2, -82.5)                       │
│ ...      │ ...                                   │
│ (16, 12) │ (595.0, 980.0)   ← 중앙!              │
│ ...      │ ...                                   │
│ (31, 23) │ (1050.3, 1750.8)                      │
└──────────┴───────────────────────────────────────┘

4개 카메라 × 32 × 24 픽셀 × 12바이트 = 약 36KB
STM32F407 RAM 192KB → 충분!
```

#### 5.3.3 생성 원리

```
입력 (설계값):
├── 카메라 위치: CAM1(0,0), CAM2(1190,0), CAM3(0,1960), CAM4(1190,1960)
├── 틸트 각도: 45° (중앙 방향)
├── Working Distance: 250mm
└── FOV: 110° × 75°

        ↓ 수학 공식 적용 (삼각함수, 회전 행렬)

출력:
└── 룩업 테이블 (각 픽셀 → 월드 좌표 매핑)
```

```
각 픽셀에 대해:

1. 픽셀 위치 → FOV 내 각도 계산
2. 카메라 틸트(45°) 적용하여 광선 방향 결정
3. 광선이 배터리 표면(Z=0)과 만나는 점 계산
4. 결과를 테이블에 저장
```

#### 5.3.4 생성 시점

| 시점 | 수행 작업 | 소요 시간 |
|------|----------|----------|
| 펌웨어 빌드 시 | 설계값으로 테이블 생성 | 1회 |
| 부팅 시 | 플래시에서 RAM으로 로드 | ~100ms |
| 실시간 | 테이블 조회만 | ~2ms/프레임 |

#### 5.3.5 장점

| 항목 | 실시간 계산 | 룩업 테이블 |
|------|------------|-------------|
| 프레임당 처리 시간 | ~50ms | ~2ms |
| CPU 부하 | 높음 | 낮음 |
| 메모리 사용 | 적음 | ~36KB |
| 구현 복잡도 | 매 프레임 수학 연산 | 초기 1회 계산 |

---

## 6. 캘리브레이션

### 6.1 캘리브레이션 전략

```
핵심 원칙: 캘리브레이션을 기계적 정밀도로 대체

복잡한 캘리브레이션 ❌ → 정밀 브라켓 사용 ✅
```

### 6.2 캘리브레이션 종류

| 종류 | 목적 | 필수 여부 | 시점 |
|------|------|----------|------|
| 기하학적 | 룩업 테이블 생성 | ✅ 필수 | 설계 시 (자동) |
| 검증 | 룩업 테이블 확인 | ✅ 권장 | 설치 후 1회 |
| 온도 오프셋 | 카메라간 편차 보정 | △ 선택 | 설치 후 1회 |

### 6.3 기하학적 캘리브레이션

```
방법: 설계값 기반 자동 생성 (열원 불필요)

┌─────────────────────────────────────────────┐
│  입력 (설계 도면에서)                         │
│  ├── 카메라 위치 (4개 모서리)                 │
│  ├── 틸트 각도 (45°)                         │
│  ├── Working Distance (250mm)               │
│  └── FOV (110° × 75°)                       │
│                                              │
│          ↓ 수학 공식으로 자동 계산            │
│                                              │
│  출력: 룩업 테이블                            │
└─────────────────────────────────────────────┘

※ 열원으로 측정하는 것이 아님!
※ 설계값만 있으면 계산 가능
```

### 6.4 정밀 브라켓

```
설계값을 신뢰할 수 있는 조건: 정밀한 기계 가공

┌──────────────────────────────────────┐
│  ┌──◢                       ◣──┐   │
│  │  │    정밀 제작된        │  │   │
│  │  │    고정 브라켓        │  │   │
│  │  │    (45° 각도 고정)    │  │   │
│  └──◥                       ◤──┘   │
└──────────────────────────────────────┘

제작 방식: CNC 가공 또는 고정밀 3D 프린팅
요구 정밀도:
├── 카메라 위치: ±1mm 이내
└── 틸트 각도: ±0.5° 이내
```

### 6.5 검증 캘리브레이션

```
목적: 룩업 테이블이 맞는지 "확인만"
방법: 열원 1개로 검증

┌─────────────────────────────────────────────┐
│                                              │
│  CAM1                              CAM2      │
│     ╲                             ╱         │
│       ╲                         ╱           │
│         ╲        🔥           ╱             │
│           ╲  (595, 980)mm   ╱               │
│             ╲             ╱                 │
│  CAM3         ╲         ╱          CAM4     │
│                                              │
└─────────────────────────────────────────────┘

확인 절차:
1. 알려진 위치 (예: 595, 980)mm에 열원 배치
2. 4개 카메라가 출력하는 좌표 확인
3. 오차 판정

오차 < 10mm → OK ✅ (룩업 테이블 정확)
오차 > 10mm → 브라켓 재조정 또는 보정값 입력
```

### 6.6 온도 오프셋 캘리브레이션 (선택)

```
목적: 카메라 개체차 보정

방법:
1. 균일한 온도면 준비 (예: 50°C 핫플레이트)
2. 각 카메라 측정값 확인
   CAM1: 50.3°C → offset = -0.3°C
   CAM2: 49.7°C → offset = +0.3°C
   CAM3: 50.5°C → offset = -0.5°C
   CAM4: 49.8°C → offset = +0.2°C
3. 오프셋 저장 → 실시간 보정 적용

※ MLX90640은 공장 캘리브레이션 되어 있어 보통 ±1°C 이내
※ 더 정밀하게 원할 경우에만 수행
```

### 6.7 전체 절차 요약

```
Step 1: 정밀 브라켓으로 설치
        └── 설계값 신뢰 가능

Step 2: 펌웨어에 설계값 입력
        ├── 카메라 위치 (4개)
        ├── 틸트 각도 (45°)
        └── WD (250mm)

Step 3: 룩업 테이블 자동 생성
        └── 펌웨어가 수학 공식으로 계산

Step 4: 검증 (약 5분)
        ├── 중앙에 열원 배치
        ├── 4개 카메라 좌표 확인
        └── 오차 10mm 이내 → 완료!

Step 5: (선택) 온도 오프셋 보정
        ├── 기준 온도면 측정
        └── 오프셋 저장
```

---

## 7. 하드웨어 설계

### 7.1 시스템 구성

```
┌─────────────────────────────────────────────────────────────┐
│                    통합 제어 보드                            │
│                                                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │MLX90640 │ │MLX90640 │ │MLX90640 │ │MLX90640 │           │
│  │  CAM1   │ │  CAM2   │ │  CAM3   │ │  CAM4   │           │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘           │
│       └─────┬─────┴─────┬─────┴─────┬─────┘                │
│             │      I2C  │           │                       │
│       ┌─────┴───────────┴───────────┴─────┐                │
│       │         I2C 멀티플렉서            │                │
│       │           TCA9548A                │                │
│       └─────────────────┬─────────────────┘                │
│                         │                                   │
│                   ┌─────┴─────┐                            │
│                   │ STM32F407 │                            │
│                   └─────┬─────┘                            │
│                         │                                   │
│                   ┌─────┴─────┐                            │
│                   │   W5500   │                            │
│                   └─────┬─────┘                            │
│                         │                                   │
│              ┌──────────┴──────────┐                       │
│              │      PoE 모듈       │                       │
│              └──────────┬──────────┘                       │
└─────────────────────────┼───────────────────────────────────┘
                          │
                     PoE 케이블
                          │
                    ┌───────────┐
                    │ PoE 스위치 │
                    └───────────┘
```

### 7.2 부품 목록

| 부품 | 모델 | 수량 | 역할 |
|------|------|------|------|
| IR 카메라 | MLX90640 광각 | 4 | 온도 측정 |
| I2C 멀티플렉서 | TCA9548A | 1 | 주소 충돌 해결 |
| MCU | STM32F407 | 1 | 데이터 처리 |
| Ethernet | W5500 | 1 | 네트워크 통신 |
| PoE 모듈 | AG9905M | 1 | 전원 수전 |

### 7.3 전원 설계

```
PoE 입력: 48V DC (IEEE 802.3af)
         │
         ▼
    ┌─────────────┐
    │  PoE 모듈   │  → 5V / 2A 출력
    └──────┬──────┘
           │
     ┌─────┴─────┐
     ▼           ▼
   3.3V         5V
  (STM32)    (MLX90640)

총 소비전력: ~3.5W (PoE 802.3af 12.95W 이내)
```

### 7.4 데이터 패킷 구조

```
┌──────────────────────────────────────────────────┐
│  Header (16 bytes)                               │
│  - Sync, Module ID, Timestamp, Status            │
├──────────────────────────────────────────────────┤
│  Payload (6,144 bytes)                           │
│  - CAM1~4 각 1,536 bytes (768 × 2)              │
├──────────────────────────────────────────────────┤
│  Footer (4 bytes)                                │
│  - CRC32                                         │
└──────────────────────────────────────────────────┘
                    총 6,164 bytes/프레임
                    전송률: ~24KB/s @ 4Hz
```

### 7.5 예상 비용

| 부품 | 단가 | 수량 | 금액 |
|------|------|------|------|
| MLX90640 광각 | $40 | 4 | $160 |
| STM32F407 | $6 | 1 | $6 |
| W5500 모듈 | $5 | 1 | $5 |
| TCA9548A | $3 | 1 | $3 |
| PoE 모듈 | $10 | 1 | $10 |
| PCB + 부품 | $20 | 1 | $20 |
| **합계** | | | **~$204/모듈** |

---

## 8. 화재 감지 알고리즘

### 8.1 감지 기준

| 감지 유형 | 조건 | 알람 레벨 |
|-----------|------|----------|
| 절대 온도 | > 60°C | WARNING |
| 절대 온도 | > 80°C | CRITICAL |
| 온도 상승률 | > 10°C/min | CRITICAL |
| 핫스팟 | 주변 대비 > 15°C | WARNING |

### 8.2 감지 전략

```
1차: 급격한 온도 상승 감지 (전체 영역)
     → ΔT > 10°C/min 알람

2차: 절대 온도 임계값 (전체 영역)
     → T > 60°C 경고, T > 80°C 알람

3차: 인접 픽셀 온도차 분석 (핫스팟)
     → 주변 대비 ΔT > 15°C 알람
```

---

## 9. 결론

### 9.1 최종 사양 요약

| 항목 | 값 |
|------|-----|
| 카메라 | MLX90640 광각 × 4 |
| 배치 | 모서리 45° 틸트 |
| 층당 카메라 수 | 4개 |
| 유효 해상도 | 20-40mm/pixel |
| 통신 | PoE (전원 + 데이터) |
| 모듈 비용 | ~$204 |

### 9.2 화재 감지 성능

| 항목 | 판정 |
|------|------|
| 열폭주 감지 | ✅ 가능 |
| 셀 단위 감지 | ✅ 가능 (2.5-5 픽셀/셀) |
| 핫스팟 위치 파악 | ✅ 가능 |
| 온도 정확도 | ✅ ±0.5°C (융합 후) |

---

## 10. 다음 단계

1. 회로도 상세 설계
2. PCB 레이아웃
3. 정밀 브라켓 3D 설계
4. 펌웨어 개발
5. 데이터 융합 알고리즘 구현
6. 프로토타입 제작 및 테스트
